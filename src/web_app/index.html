<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="theme-color" content="#62f0b8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Study Helper" />
  <meta name="description" content="Study Helper - code/quiz practice assistant" />
  <title>Study Helper | Code & Quiz Practice</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="stylesheet" href="style.css" id="main-style" />
  <script>
    // Force cache clear on every load
    (function () {
      var ts = new Date().getTime();
      var style = document.getElementById('main-style');
      if (style) style.href = 'style.css?v=' + ts;

      if ('caches' in window) {
        caches.keys().then(function (names) {
          names.forEach(function (name) { caches.delete(name); });
        });
      }

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function (registrations) {
          registrations.forEach(function (registration) {
            registration.unregister();
          });
        });
      }
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
</head>

<body>
  <header>
    <div class="brand">
      <div class="brand-logo">SH</div>
      <div>
        <div class="brand-name">Study Helper</div>
        <div class="brand-sub">Code / Quiz practice assistant</div>
      </div>
    </div>
    <div class="actions">
      <span id="ngrok-url" class="ngrok-url" style="display:none" title="Click to copy">Tunnel: loading...</span>
      <span id="mobile-url" class="mobile-url" title="Click to copy">Mobile: loading...</span>
      <span id="study-timer" class="study-timer" title="Study timer">Timer 00:00</span>
      <button id="btn-file-mode" class="primary-btn" title="Choose file/mode (F)">File / Mode</button>
      <button id="btn-shuffle" class="shuffle-btn" title="Shuffle questions (S)">Shuffle</button>
      <button id="btn-api-key" class="api-btn" title="Gemini API settings">API</button>
      <button id="btn-shutdown" class="danger-btn" title="Shutdown server">Shutdown</button>
    </div>
  </header>

  <main class="layout">
    <section class="info">
      <div class="card">
        <div class="label">Title</div>
        <div id="session-title" class="value">Load a session to begin</div>
      </div>
      <div class="card">
        <div class="label">Language</div>
        <div id="session-lang" class="value">-</div>
      </div>
      <div class="card">
        <div class="label">Mode</div>
        <div id="session-mode" class="value">-</div>
      </div>
      <div class="card">
        <div class="label">Blanks</div>
        <div id="session-count" class="value">0</div>
      </div>
      <div class="card">
        <div class="label">Score</div>
        <div id="session-score" class="value">0 / 0</div>
        <div id="session-progress" class="progress-bar"><span style="width:0%"></span></div>
      </div>
    </section>

    <section class="controls">
      <div class="controls-left">
        <span id="streak-counter" class="streak-badge" style="display:none">🔥 0</span>
        <span class="badge">Enter: fill + auto-jump</span>
        <span class="hint emphasis">Ctrl+Enter: grade all / Shift+Enter: grade current (Mode 3)</span>
        <span id="review-badge" class="hint emphasis">Review 0</span>
      </div>
      <div class="controls-right">
        <button id="btn-reveal" title="Reveal answers (V)">Reveal</button>
        <button id="btn-regenerate" class="regen-btn" title="Regenerate blanks (AI/local)">Regenerate</button>
        <button id="btn-toggle-completed" class="ghost-btn" title="Toggle completed">Toggle Done</button>
        <button id="btn-review" title="Open review list">Review</button>
        <button id="btn-reset" title="Reset progress (R)">Reset</button>
      </div>
    </section>

    <section class="workspace">
      <aside class="blank-nav" id="blank-nav">
        <div class="nav-header">
          <div class="nav-title">Blank list</div>
          <button id="btn-toggle-nav" class="toggle-nav-btn" title="Hide list">List</button>
        </div>
        <div class="nav-sub">Status: unanswered / correct / hint used / wrong</div>
        <div id="blank-list" class="blank-list"></div>
      </aside>
      <button id="btn-show-nav" class="show-nav-btn" title="Show blank list">Show list</button>

      <section class="code-shell">
        <div class="toolbar">
          <div class="toolbar-left">
            <span class="badge">Problem code</span>
            <span class="hint">Auto-number blanks + copy code</span>
          </div>
          <div class="toolbar-right">
            <span class="hint">Ctrl+L: toggle AI panel</span>
          </div>
        </div>
        <div id="code-area" class="code-area"></div>
      </section>
    </section>

    <section class="answer-panel">
      <details>
        <summary>Show answers / solution</summary>
        <pre id="answer-block" class="answer-block"></pre>
      </details>
    </section>
  </main>

  <div id="floating-explain" class="floating-explain" style="display:none;">
    <button id="btn-explain-selection">Explain selected code</button>
  </div>

  <aside id="ai-panel" class="ai-panel">
    <div class="ai-panel-header">
      <h3>Ask AI</h3>
      <div class="ai-panel-header-btns">
        <button id="btn-ai-new" class="icon-btn" title="New chat">⟳</button>
        <button id="btn-ai-history" class="icon-btn" title="History">📜</button>
        <button id="btn-close-panel" class="icon-btn" title="Close">✕</button>
      </div>
    </div>

    <div class="ai-panel-resize-handle" id="ai-panel-resize"></div>

    <div class="ai-panel-content">
      <div class="chat-messages-wrapper">
        <div id="chat-messages" class="chat-messages"></div>
      </div>
      <div class="chat-input-area">
        <textarea id="chat-input" placeholder="Ask anything... (Enter=send)"></textarea>
        <button id="btn-send-chat" class="chat-send-btn">Send</button>
      </div>
    </div>
  </aside>

  <div id="api-key-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Gemini API Key</h3>
      <p>Provide your Google Gemini API key to enable AI generation.</p>
      <input type="password" id="api-key-input" placeholder="Enter API key" />
      <div class="modal-actions">
        <button id="btn-save-api-key">Save</button>
        <button id="btn-cancel-api-key">Cancel</button>
      </div>
      <p class="hint">The key is stored locally only; local mode works without it.</p>
    </div>
  </div>

  <div id="regenerate-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Regenerate blanks</h3>
      <p>Enter the number of blanks to generate (10-100)</p>
      <input type="number" id="regen-count-input" value="50" min="10" max="100" />
      <div class="modal-actions">
        <button id="btn-confirm-regen">Generate</button>
        <button id="btn-cancel-regen">Cancel</button>
      </div>
    </div>
  </div>

  <div id="file-mode-modal" class="modal" style="display:none;">
    <div class="modal-content file-mode-modal">
      <h3>Choose default file & mode</h3>

      <div class="fm-section">
        <label>Default files</label>
        <div class="fm-presets" id="preset-buttons">
          <button class="fm-preset" data-preset="oop_vocab" data-default-mode="7">1) OOP Vocabulary</button>
          <button class="fm-preset" data-preset="oop_concept" data-default-mode="5">2) OOP Concepts</button>
          <button class="fm-preset" data-preset="oop_code" data-default-mode="1">3) OOP Code Blanks</button>
          <button class="fm-preset" data-preset="data_structure" data-default-mode="3">4) Data Structure Code</button>
          <button class="fm-preset" data-preset="math_theory" data-default-mode="4">5) Computational Math Theory</button>
          <button class="fm-preset" data-preset="math_practice" data-default-mode="6">6) Computational Math Practice</button>
          <label class="fm-preset fm-upload">
            <input type="file" id="custom-file-input" accept=".txt,.py,.c,.cpp,.java,.js,.cs" style="display:none" />
            Upload custom file
          </label>
        </div>
        <p class="fm-selected">Selected file: <span id="selected-file-name">1_OOP_Vocabulary.txt</span></p>
      </div>

      <div class="fm-section">
        <label>Modes</label>
        <div class="fm-modes" id="mode-buttons">
          <button class="fm-mode" data-mode="1">1. OOP fill-in-the-blank</button>
          <button class="fm-mode" data-mode="2">2. Data structure blanks</button>
          <button class="fm-mode active" data-mode="3">3. Blank sheet coding</button>
          <button class="fm-mode" data-mode="4">4. Mock exam</button>
          <button class="fm-mode" data-mode="5">5. Definition quiz</button>
          <button class="fm-mode" data-mode="6">6. Computational math coding</button>
          <button class="fm-mode" data-mode="7">7. Vocabulary drill</button>
        </div>
      </div>

      <div class="fm-section" id="difficulty-section" style="display:none;">
        <label>Difficulty <span class="fm-hint">(Mode 1, 2)</span></label>
        <div class="fm-difficulty" id="difficulty-buttons">
          <button class="fm-diff" data-diff="easy">Easy</button>
          <button class="fm-diff active" data-diff="normal">Normal</button>
          <button class="fm-diff" data-diff="hard">Hard</button>
          <button class="fm-diff" data-diff="extreme">Extreme</button>
        </div>
        <p class="fm-diff-hint" id="diff-hint">Normal: 30% hints + 40% blanks</p>
      </div>

      <div class="fm-section">
        <label>Generation method</label>
        <div class="fm-methods" id="method-buttons">
          <button class="fm-method active" data-method="local">Local (fast)</button>
          <button class="fm-method" data-method="ai">AI (Gemini)</button>
        </div>
        <p class="fm-method-hint">Local: instant. AI: uses Gemini API for custom generation.</p>
      </div>

      <div class="modal-actions">
        <button id="btn-generate-session" class="primary">Build session</button>
        <button id="btn-cancel-fm">Cancel</button>
      </div>

      <p id="fm-status" class="fm-status"></p>
      <div id="ai-progress-container" class="progress-bar-container" style="display:none; margin-top: 10px;">
        <div class="progress-bar-fill" id="ai-progress-fill" style="width: 0%"></div>
      </div>
      <p id="ai-progress-text" style="display:none; text-align: center; font-size: 12px; color: var(--muted); margin-top: 5px;">0%</p>
    </div>
  </div>

  <button id="btn-ai-toggle" class="floating-ai-toggle">AI</button>
  <button id="btn-scroll-top" class="floating-top">Top</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    const script = document.createElement('script');
    script.src = 'app.js?v=' + new Date().getTime();
    document.body.appendChild(script);

    window.addEventListener('unload', function () {
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage('CLEAR_CACHE');
      }
      try {
        localStorage.removeItem('quiz_session_progress');
      } catch (e) { }
    });
  </script>
</body>
</html>
