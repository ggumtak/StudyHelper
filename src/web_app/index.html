<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="theme-color" content="#62f0b8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Study Helper" />
  <meta name="description" content="Study Helper - code/quiz practice assistant" />
  <link rel="icon" type="image/png" href="icon-192.png" />
  <title>Study Helper | Code & Quiz Practice</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="stylesheet" href="style.css" id="main-style" />
  <script>
    // Force cache clear on every load
    (function () {
      var ts = new Date().getTime();
      var style = document.getElementById('main-style');
      if (style) style.href = 'style.css?v=' + ts;

      if ('caches' in window) {
        caches.keys().then(function (names) {
          names.forEach(function (name) { caches.delete(name); });
        });
      }

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function (registrations) {
          registrations.forEach(function (registration) {
            registration.unregister();
          });
        });
      }
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
</head>

<body>
  <header>
    <div class="brand">
      <div class="brand-logo">SH</div>
      <div>
        <div class="brand-name">Study Helper</div>
        <div class="brand-sub">코드 / 퀴즈 연습 도우미</div>
      </div>
    </div>
    <div class="actions">
      <span id="ngrok-url" class="ngrok-url" style="display:none" title="클릭하여 복사">터널: 불러오는 중...</span>
      <span id="mobile-url" class="mobile-url" title="클릭하여 복사">모바일: 불러오는 중...</span>
      <span id="study-timer" class="study-timer" title="학습 타이머">타이머 00:00</span>
      <button id="btn-file-mode" class="primary-btn" title="파일/모드 선택 (F)">파일 / 모드</button>
      <button id="btn-shuffle" class="shuffle-btn" title="문제 섞기 (S)">섞기</button>
      <button id="btn-api-key" class="api-btn" title="Gemini API 설정">API 키</button>
    </div>
  </header>

  <main class="layout">
    <section class="info">
      <div class="card">
        <div class="label">제목</div>
        <div id="session-title" class="value">세션을 불러와 시작하세요</div>
      </div>
      <div class="card">
        <div class="label">언어</div>
        <div id="session-lang" class="value">-</div>
      </div>
      <div class="card">
        <div class="label">모드</div>
        <div id="session-mode" class="value">-</div>
      </div>
      <div class="card">
        <div class="label">빈칸</div>
        <div id="session-count" class="value">0</div>
      </div>
      <div class="card">
        <div class="label">점수</div>
        <div id="session-score" class="value">0 / 0</div>
        <div id="session-progress" class="progress-bar"><span style="width:0%"></span></div>
      </div>
    </section>

    <section class="controls">
      <div class="controls-left">
        <span id="streak-counter" class="streak-badge" style="display:none">연속 0</span>
        <span class="badge">Enter: 채우고 자동 이동</span>
        <span class="hint emphasis">Ctrl+Enter: 전체 채점 / Shift+Enter: 현재만 채점 (모드 3)</span>
        <span id="review-badge" class="hint emphasis">복습 0</span>
      </div>
      <div class="controls-right">
        <button id="btn-reveal" title="정답 보기 (V)">정답 보기</button>
        <button id="btn-regenerate" class="regen-btn" title="빈칸 다시 만들기 (AI/로컬)">재생성</button>
        <button id="btn-toggle-completed" class="ghost-btn" title="완료 표시 토글">완료 표시</button>
        <button id="btn-review" title="복습 목록 열기">복습</button>
        <button id="btn-reset" title="진행 초기화 (R)">초기화</button>
      </div>
    </section>

    <section class="workspace">
      <aside class="blank-nav" id="blank-nav">
        <div class="nav-header">
          <div class="nav-title">빈칸 목록</div>
          <button id="btn-toggle-nav" class="toggle-nav-btn" title="목록 닫기">목록 닫기</button>
        </div>
        <div class="nav-sub status-legend">
          <span>상태:</span>
          <span class="legend-dot pending"></span><span class="legend-label">미답</span>
          <span class="legend-dot correct"></span><span class="legend-label">정답</span>
          <span class="legend-dot revealed"></span><span class="legend-label">힌트 사용</span>
          <span class="legend-dot wrong"></span><span class="legend-label">오답</span>
        </div>
        <div id="blank-list" class="blank-list"></div>
      </aside>
      <button id="btn-show-nav" class="show-nav-btn" title="목록 보기">목록</button>

      <section class="code-shell">
        <div class="toolbar">
          <div class="toolbar-left">
            <span class="badge">문제 코드</span>
            <span class="hint">빈칸 자동 번호 + 코드 복사</span>
          </div>
          <div class="toolbar-right">
            <span class="hint">Ctrl+L: AI 패널 토글</span>
          </div>
        </div>
        <div id="code-area" class="code-area"></div>
      </section>
    </section>

    <section class="answer-panel">
      <details>
        <summary>정답 / 해설 보기</summary>
        <pre id="answer-block" class="answer-block"></pre>
      </details>
    </section>
  </main>

  <div id="floating-explain" class="floating-explain" style="display:none;">
    <button id="btn-explain-selection">선택 코드 설명</button>
  </div>

  <aside id="ai-panel" class="ai-panel">
    <div class="ai-panel-header">
      <h3>AI에게 질문</h3>
      <div class="ai-panel-header-btns">
        <button id="btn-ai-new" class="icon-btn" title="새 대화" aria-label="새 대화">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
            <path d="M3 8h10M8 3v10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </button>
        <button id="btn-ai-history" class="icon-btn" title="대화 기록" aria-label="대화 기록">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
            <circle cx="8" cy="8" r="6.5" stroke="currentColor" stroke-width="1.2"/>
            <path d="M8 4.5v4l2.5 1.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button id="btn-close-panel" class="icon-btn" title="닫기" aria-label="닫기">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
            <path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="ai-panel-resize-handle" id="ai-panel-resize"></div>

    <div class="ai-panel-content">
      <div class="chat-messages-wrapper">
        <div id="chat-messages" class="chat-messages"></div>
      </div>
      <div class="chat-input-area">
        <textarea id="chat-input" placeholder="무엇이든 물어보세요... (Enter=전송)"></textarea>
        <button id="btn-send-chat" class="chat-send-btn">전송</button>
      </div>
    </div>
  </aside>

  <div id="api-key-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Gemini API 키</h3>
      <p>Google Gemini API 키를 입력하면 AI 생성을 사용할 수 있습니다.</p>
      <input type="password" id="api-key-input" placeholder="API 키 입력" />
      <div class="modal-actions">
        <button id="btn-save-api-key">저장</button>
        <button id="btn-cancel-api-key">취소</button>
      </div>
      <p class="hint">키는 로컬에만 저장되며, 로컬 모드는 키 없이도 동작합니다.</p>
    </div>
  </div>

  <div id="regenerate-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>빈칸 다시 만들기</h3>
      <p>생성할 빈칸 개수 입력 (10-100)</p>
      <input type="number" id="regen-count-input" value="50" min="10" max="100" />
      <div class="modal-actions">
        <button id="btn-confirm-regen">생성</button>
        <button id="btn-cancel-regen">취소</button>
      </div>
    </div>
  </div>

  <div id="file-mode-modal" class="modal" style="display:none;">
    <div class="modal-content file-mode-modal">
      <h3>기본 파일과 모드 선택</h3>

      <div class="fm-section">
        <label>기본 파일</label>
        <div class="fm-presets" id="preset-buttons">
          <button class="fm-preset" data-preset="oop_vocab" data-default-mode="7">1) OOP 단어</button>
          <button class="fm-preset" data-preset="oop_concept" data-default-mode="5">2) OOP 개념</button>
          <button class="fm-preset" data-preset="oop_code" data-default-mode="1">3) OOP 코드 빈칸</button>
          <button class="fm-preset" data-preset="data_structure" data-default-mode="3">4) 자료구조 코드</button>
          <button class="fm-preset" data-preset="math_theory" data-default-mode="4">5) 전산수학 이론</button>
          <button class="fm-preset" data-preset="math_practice" data-default-mode="6">6) 전산수학 실습</button>
          <label class="fm-preset fm-upload">
            <input type="file" id="custom-file-input" accept=".txt,.py,.c,.cpp,.java,.js,.cs" style="display:none" />
            사용자 파일 업로드
          </label>
        </div>
        <p class="fm-selected">선택된 파일: <span id="selected-file-name">1_OOP_Vocabulary.txt</span></p>
      </div>

      <div class="fm-section">
        <label>모드</label>
        <div class="fm-modes" id="mode-buttons">
          <button class="fm-mode" data-mode="1">1. OOP 빈칸 채우기</button>
          <button class="fm-mode" data-mode="2">2. 자료구조 빈칸</button>
          <button class="fm-mode active" data-mode="3">3. 백지 코딩</button>
          <button class="fm-mode" data-mode="4">4. 모의고사</button>
          <button class="fm-mode" data-mode="5">5. 정의 퀴즈</button>
          <button class="fm-mode" data-mode="6">6. 전산수학 코딩</button>
          <button class="fm-mode" data-mode="7">7. 단어 연습</button>
        </div>
      </div>

      <div class="fm-section" id="difficulty-section" style="display:none;">
        <label>난이도 <span class="fm-hint">(모드 1, 2)</span></label>
        <div class="fm-difficulty" id="difficulty-buttons">
          <button class="fm-diff" data-diff="easy">쉬움</button>
          <button class="fm-diff active" data-diff="normal">보통</button>
          <button class="fm-diff" data-diff="hard">어려움</button>
          <button class="fm-diff" data-diff="extreme">극한</button>
        </div>
        <p class="fm-diff-hint" id="diff-hint">보통: 중간 정도의 빈칸 비율</p>
      </div>

      <div class="fm-section">
        <label>생성 방법</label>
        <div class="fm-methods" id="method-buttons">
          <button class="fm-method active" data-method="local">로컬 (빠름)</button>
          <button class="fm-method" data-method="ai">AI (Gemini)</button>
        </div>
        <p class="fm-method-hint">로컬: 즉시 생성. AI: Gemini API로 맞춤 생성.</p>
      </div>

      <div class="modal-actions">
        <button id="btn-generate-session" class="primary">세션 만들기</button>
        <button id="btn-cancel-fm">취소</button>
      </div>

      <p id="fm-status" class="fm-status"></p>
      <div id="ai-progress-container" class="progress-bar-container" style="display:none; margin-top: 10px;">
        <div class="progress-bar-fill" id="ai-progress-fill" style="width: 0%"></div>
      </div>
      <p id="ai-progress-text" style="display:none; text-align: center; font-size: 12px; color: var(--muted); margin-top: 5px;">0%</p>
    </div>
  </div>

  <button id="btn-ai-toggle" class="floating-ai-toggle">AI</button>
  <button id="btn-scroll-top" class="floating-top">맨 위</button>

  <script src="js/foundation.js"></script>
  <script src="js/legacy/alerts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script type="module">
    import { applyKoreanUI, applyStaticTexts } from './js/i18n.js';

    applyStaticTexts();

    const script = document.createElement('script');
    script.type = 'module';
    script.src = 'app.js?v=' + new Date().getTime();
    script.addEventListener('load', () => applyKoreanUI());
    document.body.appendChild(script);

    window.addEventListener('unload', function () {
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage('CLEAR_CACHE');
      }
      try {
        localStorage.removeItem('quiz_session_progress');
      } catch (e) { }
    });
  </script>
</body>
</html>
